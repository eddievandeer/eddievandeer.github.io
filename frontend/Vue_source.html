<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue源码笔记 | Vivek的博客小站</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/assets/icon/favicon.ico">
    <meta name="description" content="May the force be with you">
    <link rel="preload" href="/assets/css/0.styles.93617c20.css" as="style"><link rel="preload" href="/assets/js/app.20c08001.js" as="script"><link rel="preload" href="/assets/js/3.72c36e53.js" as="script"><link rel="preload" href="/assets/js/2.b6f9ecfe.js" as="script"><link rel="preload" href="/assets/js/24.14c366a0.js" as="script"><link rel="prefetch" href="/assets/js/10.37f06347.js"><link rel="prefetch" href="/assets/js/11.acc626cb.js"><link rel="prefetch" href="/assets/js/12.7ff649d6.js"><link rel="prefetch" href="/assets/js/13.282d60b6.js"><link rel="prefetch" href="/assets/js/14.72f0d7aa.js"><link rel="prefetch" href="/assets/js/15.12b204b5.js"><link rel="prefetch" href="/assets/js/16.345e5f7a.js"><link rel="prefetch" href="/assets/js/17.7f6a84f8.js"><link rel="prefetch" href="/assets/js/18.99836cca.js"><link rel="prefetch" href="/assets/js/19.a46b5e7d.js"><link rel="prefetch" href="/assets/js/20.1a67bf54.js"><link rel="prefetch" href="/assets/js/21.b82d960a.js"><link rel="prefetch" href="/assets/js/22.ab24359d.js"><link rel="prefetch" href="/assets/js/23.c60e87c2.js"><link rel="prefetch" href="/assets/js/25.02836311.js"><link rel="prefetch" href="/assets/js/26.166b64c1.js"><link rel="prefetch" href="/assets/js/4.6bf3547d.js"><link rel="prefetch" href="/assets/js/5.21141511.js"><link rel="prefetch" href="/assets/js/6.238316b6.js"><link rel="prefetch" href="/assets/js/7.cb4bfad0.js"><link rel="prefetch" href="/assets/js/8.3219af6d.js"><link rel="prefetch" href="/assets/js/9.46eb29f1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.93617c20.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-3fe049a8><div class="blog-header" data-v-3fe049a8><div class="tool-bar" data-v-45f474db><div class="tool-bar-1" data-v-45f474db><div class="navigation-bar" data-v-45f474db><div class="bar-item"><a href="/" class="router-link-active"><button type="button">首页</button></a></div><div class="bar-item"><a href="/frontend/" class="router-link-active"><button type="button">前端笔记</button></a></div><div class="bar-item"><a href="/album/"><button type="button">画册</button></a></div><div class="bar-list">
    工具箱   <i aria-hidden="true" class="fa fa-caret-down"></i> <div class="bar-item-list"><div class="bar-item"><a href="https://tinypng.com/" target="_blank"><button type="button">
            图片压缩
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div><div class="bar-item"><a href="https://sm.ms/" target="_blank"><button type="button">
            免费图床
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div><div class="bar-item"><a href="https://www.iconfont.cn/home/index" target="_blank"><button type="button">
            矢量图标库
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div><div class="bar-item"><a href="http://zhongguose.com/" target="_blank"><button type="button">
            中国色
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div><div class="bar-item"><a href="https://learngitbranching.js.org/?locale=zh_CN" target="_blank"><button type="button">
            Git可视化学习
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div><div class="bar-item"><a href="https://flatuicolors.com/" target="_blank"><button type="button">
            取色板
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div></div></div><div class="bar-item"><a href="/about"><button type="button">关于</button></a></div></div></div> <div class="mobile-bar" data-v-ea892f7c data-v-45f474db><div class="mobile-bar-list" data-v-575b05a5 data-v-ea892f7c><button class="show-list" data-v-575b05a5><i aria-hidden="true" class="fa fa-bars" data-v-575b05a5></i></button> <div class="list-container hide" data-v-165e2072 data-v-575b05a5></div></div> <div class="home-link" data-v-ea892f7c><a href="/" data-v-ea892f7c><h2 class="title" data-v-ea892f7c>首页</h2></a></div></div> <div class="search" data-v-45f474db><div class="search-box" data-v-45f474db><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="tool-bar-2" data-v-45f474db><div class="bar-item" data-v-45f474db><a href="https://codepen.io/eddievandeer" target="_blank"><button type="button">
            CodePen
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div><div class="bar-item" data-v-45f474db><a href="https://github.com/eddievandeer/eddievandeer.github.io" target="_blank"><button type="button">
            GitHub
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div></div></div></div> <div class="index-container" data-v-55648b28 data-v-3fe049a8><div class="list-container hide" data-v-165e2072 data-v-55648b28></div></div> <div class="article" data-v-3fe049a8><div class="article-detail" data-v-3fe049a8><div class="content__default" data-v-3fe049a8><h1 id="vue源码笔记"><a href="#vue源码笔记" class="header-anchor">#</a> Vue源码笔记</h1> <h2 id="数据劫持"><a href="#数据劫持" class="header-anchor">#</a> 数据劫持</h2> <h3 id="原理流程图"><a href="#原理流程图" class="header-anchor">#</a> 原理流程图</h3> <p><img src="https://i.loli.net/2020/10/25/W5HPJ4gNG7OKb2y.png" alt="image.png"></p> <h3 id="初始化-init"><a href="#初始化-init" class="header-anchor">#</a> 初始化 init</h3> <p>将创建Vue对象时传入的 <code>options</code> 对象和options中的 <code>data</code> 挂载到vm示例上</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Vue</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 将options对象挂载到vm示例上</span>
    vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> options

    <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> options <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options

      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 初始化data</span>
            <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data

    <span class="token comment">// 将data()函数返回的数据绑定到实例的_data上</span>
    vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">data</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 代理数据</span>
        <span class="token function">proxyData</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'_data'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用数据的观察者观察数据</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>将 <code>options</code> 以 <code>$options</code> 形式， <code>data</code> 以 <code>_data_</code> 形式，挂载在实例上</p> <p><img src="https://i.loli.net/2020/10/26/sOAYtQkwcy7pzH9.png" alt="image.png"></p> <h3 id="代理-proxy"><a href="#代理-proxy" class="header-anchor">#</a> 代理 proxy</h3> <p>代理就是使用 <code>vm.xxx</code> 去获取或更改 <code>vm._data.xxx</code> ，同时也将 <code>data</code> 上的所有属性挂载在实例上</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">proxyData</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 此处的前两个参数可以理解为：vm.xxx(key为.后xxx)</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token comment">// 使用代理后可以直接使用vm.xxx来获取或修改vm._data.xxx</span>
            <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span> vm<span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  vm<span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
            <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 官方源码</span>
<span class="token keyword">function</span> <span class="token function">proxy</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> sourceKey<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">proxyGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">proxySetter</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> sharedPropertyDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="观察者-observer"><a href="#观察者-observer" class="header-anchor">#</a> 观察者 observer</h3> <p>对data及其内部的属性进行观察，由于对对象和数组的处理方法不一样，需要分两部分处理：</p> <ul><li>处理对象使用 <code>Object.defineProperty</code> 方法</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 只观察引用类型，即对象或数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> data <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> data <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">var</span> ob
    <span class="token comment">// 已被观察则返回data.__ob__，省去多余操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>__ob__ <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>__ob__ <span class="token keyword">instanceof</span> <span class="token class-name">Observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ob <span class="token operator">=</span> data<span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ob
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">def</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> enumerable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        value<span class="token operator">:</span> val<span class="token punctuation">,</span>
        enumerable<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>enumerable<span class="token punctuation">,</span>
        writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        configurable<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Observer</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将Observer对象挂载到被观察的对象上，标识是否已被观察</span>
    <span class="token function">def</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrMethods
        <span class="token function">observeArr</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">Observer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">walk</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token comment">// 遍历data的所有key和value</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
            value <span class="token operator">=</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>

        <span class="token function">defineReactiveData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>添加响应式数据处理</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">defineReactiveData</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 递归观察</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 响应式数据获取</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'响应式数据获取: '</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> value
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 响应式数据设置</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'响应式数据设置'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token keyword">return</span>
            <span class="token comment">// 观察新值</span>
            <span class="token function">observe</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
            value <span class="token operator">=</span> newValue
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>若是数组，则需要对数组方法进行拦截</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 存放所有会改变原数组的方法</span>
<span class="token keyword">var</span> <span class="token constant">ARR_METHODS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'push'</span><span class="token punctuation">,</span>
    <span class="token string">'pop'</span><span class="token punctuation">,</span>
    <span class="token string">'shift'</span><span class="token punctuation">,</span>
    <span class="token string">'unshift'</span><span class="token punctuation">,</span>
    <span class="token string">'splice'</span><span class="token punctuation">,</span>
    <span class="token string">'sort'</span><span class="token punctuation">,</span>
    <span class="token string">'reverse'</span>
<span class="token punctuation">]</span>

<span class="token comment">// 继承Array类</span>
<span class="token keyword">var</span> originArrMethods <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span>
    arrMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>originArrMethods<span class="token punctuation">)</span>

<span class="token comment">// 遍历ARR_METHODS，一个一个重写里面的方法</span>
<span class="token constant">ARR_METHODS</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    arrMethods<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数组新方法'</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">,</span>
            rt <span class="token operator">=</span> originArrMethods<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>

        <span class="token keyword">var</span> newArr

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token operator">:</span>
                newArr <span class="token operator">=</span> args
                <span class="token keyword">break</span>
            <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token operator">:</span>
                newArr <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span>
        <span class="token punctuation">}</span>

        newArr <span class="token operator">&amp;&amp;</span> <span class="token function">observeArr</span><span class="token punctuation">(</span>newArr<span class="token punctuation">)</span>
        <span class="token keyword">return</span> rt
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">observeArr</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">observe</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>重写所有会改变原数组的方法：</p> <p><img src="https://i.loli.net/2020/10/26/xrNTctaFl8PVBnI.png" alt="image.png"></p> <h2 id="模板编译"><a href="#模板编译" class="header-anchor">#</a> 模板编译</h2> <h3 id="原理流程图-2"><a href="#原理流程图-2" class="header-anchor">#</a> 原理流程图</h3> <p><img src="https://i.loli.net/2020/10/25/VsgfWzO1rAT2m8X.png" alt="image.png"></p> <h3 id="编译入口"><a href="#编译入口" class="header-anchor">#</a> 编译入口</h3> <p>通过<strong>el</strong>或<strong>template</strong>或<strong>render</strong>来获取template</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> inBrowser <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">;</span>

<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
          options <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options

    el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> inBrowser <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span>
    vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> el

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>template <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            template <span class="token operator">=</span> el<span class="token punctuation">.</span>outerHTML
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">compileToRenderFunction</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span>
        options<span class="token punctuation">.</span>render <span class="token operator">=</span> render
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="构建ast树"><a href="#构建ast树" class="header-anchor">#</a> 构建AST树</h3> <p>通过获取的template来生成AST树（Abstract Syntax Tree）抽象语法树</p> <ul><li>使用正则去匹配标签名、属性等：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 匹配属性：id=&quot;app&quot; | id='app | id=app</span>
<span class="token keyword">const</span> attribute <span class="token operator">=</span> <span class="token regex">/^\s*([^\s&quot;'&lt;&gt;\/=]+)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|'([^']*)'+|([^\s&quot;'=&lt;&gt;`]+)))?/</span>
<span class="token comment">// 匹配标签名</span>
<span class="token keyword">const</span> ncname <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[a-zA-Z_][\\-\\.0-9_a-zA-Z]*</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> qnameCapture <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">((?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\:)?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
<span class="token comment">// 匹配开始标签：&lt;div</span>
<span class="token keyword">const</span> startTagOpen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token comment">// 匹配结束标签：&gt; | /&gt;</span>
<span class="token keyword">const</span> startTagClose <span class="token operator">=</span> <span class="token regex">/^\s*(\/?)&gt;/</span>
<span class="token comment">// 匹配整个结束标签：&lt;/div&gt;</span>
<span class="token keyword">const</span> endTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;\\/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[^&gt;]*&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre></div><ul><li></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> end<span class="token punctuation">,</span>
        attr

    <span class="token keyword">const</span> start <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagOpen<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token punctuation">{</span>
            tagName<span class="token operator">:</span> start<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            attrs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>start<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>end <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>attr <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                name<span class="token operator">:</span> attr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                value<span class="token operator">:</span> attr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">||</span> attr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">||</span> attr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token function">advance</span><span class="token punctuation">(</span>attr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">advance</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            <span class="token keyword">return</span> match
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="依赖收集"><a href="#依赖收集" class="header-anchor">#</a> 依赖收集</h2></div></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.20c08001.js" defer></script><script src="/assets/js/3.72c36e53.js" defer></script><script src="/assets/js/2.b6f9ecfe.js" defer></script><script src="/assets/js/24.14c366a0.js" defer></script>
  </body>
</html>
