<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue源码笔记 | Vivek的博客小站</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/assets/icon/favicon.ico">
    <meta name="description" content="May the force be with you">
    <link rel="preload" href="/assets/css/0.styles.b32544fb.css" as="style"><link rel="preload" href="/assets/js/app.c0739d9a.js" as="script"><link rel="preload" href="/assets/js/3.2317019a.js" as="script"><link rel="preload" href="/assets/js/2.d1fb53ea.js" as="script"><link rel="preload" href="/assets/js/26.8ff8d018.js" as="script"><link rel="preload" href="/assets/js/7.441501ce.js" as="script"><link rel="prefetch" href="/assets/js/10.1cc7c7f8.js"><link rel="prefetch" href="/assets/js/11.2fb702c9.js"><link rel="prefetch" href="/assets/js/12.ef811a84.js"><link rel="prefetch" href="/assets/js/13.503b44a6.js"><link rel="prefetch" href="/assets/js/14.e57e0404.js"><link rel="prefetch" href="/assets/js/15.152ef9c7.js"><link rel="prefetch" href="/assets/js/16.6c4e04ba.js"><link rel="prefetch" href="/assets/js/17.50e06b4f.js"><link rel="prefetch" href="/assets/js/18.7d7876f7.js"><link rel="prefetch" href="/assets/js/19.06cb354b.js"><link rel="prefetch" href="/assets/js/20.a114d7d6.js"><link rel="prefetch" href="/assets/js/21.4755dfb2.js"><link rel="prefetch" href="/assets/js/22.b545977c.js"><link rel="prefetch" href="/assets/js/23.291e42f7.js"><link rel="prefetch" href="/assets/js/24.2b086e2e.js"><link rel="prefetch" href="/assets/js/25.31b360c6.js"><link rel="prefetch" href="/assets/js/27.c8253a59.js"><link rel="prefetch" href="/assets/js/28.1c6a08fe.js"><link rel="prefetch" href="/assets/js/29.d78944b4.js"><link rel="prefetch" href="/assets/js/30.d3539310.js"><link rel="prefetch" href="/assets/js/4.7c827ee4.js"><link rel="prefetch" href="/assets/js/5.46cf7500.js"><link rel="prefetch" href="/assets/js/6.2cc8869b.js"><link rel="prefetch" href="/assets/js/8.989e10d5.js"><link rel="prefetch" href="/assets/js/9.04b5b659.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b32544fb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-6c3d5eab><div class="blog-header" data-v-6c3d5eab><div class="tool-bar" data-v-45f474db><div class="tool-bar-1" data-v-45f474db><div class="navigation-bar" data-v-45f474db><div class="bar-item"><a href="/" class="router-link-active"><button type="button">首页</button></a></div><div class="bar-item"><a href="/frontend/" class="router-link-active"><button type="button">前端笔记</button></a></div><div class="bar-item"><a href="/album/"><button type="button">画册</button></a></div><div class="bar-list">
    工具箱   <i aria-hidden="true" class="fa fa-caret-down"></i> <div class="bar-item-list"><div class="bar-item"><a href="https://tinypng.com/" target="_blank"><button type="button">
            图片压缩
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div><div class="bar-item"><a href="https://sm.ms/" target="_blank"><button type="button">
            免费图床
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div><div class="bar-item"><a href="https://www.iconfont.cn/home/index" target="_blank"><button type="button">
            矢量图标库
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div><div class="bar-item"><a href="http://zhongguose.com/" target="_blank"><button type="button">
            中国色
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div><div class="bar-item"><a href="https://learngitbranching.js.org/?locale=zh_CN" target="_blank"><button type="button">
            Git可视化学习
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div><div class="bar-item"><a href="https://flatuicolors.com/" target="_blank"><button type="button">
            取色板
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div></div></div><div class="bar-item"><a href="/about"><button type="button">关于</button></a></div></div></div> <div class="mobile-bar" data-v-ea892f7c data-v-45f474db><div class="mobile-bar-list" data-v-575b05a5 data-v-ea892f7c><button class="show-list" data-v-575b05a5><i aria-hidden="true" class="fa fa-bars" data-v-575b05a5></i></button> <div class="list-container hide" data-v-165e2072 data-v-575b05a5></div></div> <div class="home-link" data-v-ea892f7c><a href="/" data-v-ea892f7c><h2 class="title" data-v-ea892f7c>首页</h2></a></div></div> <div class="search" data-v-45f474db><div class="search-box" data-v-45f474db><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="tool-bar-2" data-v-45f474db><div class="bar-item" data-v-45f474db><a href="https://codepen.io/eddievandeer" target="_blank"><button type="button">
            CodePen
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div><div class="bar-item" data-v-45f474db><a href="https://github.com/eddievandeer/eddievandeer.github.io" target="_blank"><button type="button">
            GitHub
            <i aria-hidden="true" class="fa fa-external-link"></i></button></a></div></div></div></div> <div class="index-container" data-v-55648b28 data-v-6c3d5eab><div class="list-container hide" data-v-165e2072 data-v-55648b28></div></div> <div class="article" data-v-6c3d5eab><div class="article-detail" data-v-6c3d5eab><div class="content__default" data-v-6c3d5eab><h1 id="vue源码笔记"><a href="#vue源码笔记" class="header-anchor">#</a> Vue源码笔记</h1> <h2 id="数据劫持"><a href="#数据劫持" class="header-anchor">#</a> 数据劫持</h2> <h3 id="原理流程图"><a href="#原理流程图" class="header-anchor">#</a> 原理流程图</h3> <p><img src="https://i.loli.net/2020/10/25/W5HPJ4gNG7OKb2y.png" alt="image.png"></p> <h3 id="初始化-init"><a href="#初始化-init" class="header-anchor">#</a> 初始化 init</h3> <p>将创建Vue对象时传入的 <code>options</code> 对象和options中的 <code>data</code> 挂载到vm示例上</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Vue</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 将options对象挂载到vm示例上</span>
    vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> options

    <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> options <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options

      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 初始化data</span>
            <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data

    <span class="token comment">// 将data()函数返回的数据绑定到实例的_data上</span>
    vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">data</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 代理数据</span>
        <span class="token function">proxyData</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'_data'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用数据的观察者观察数据</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>将 <code>options</code> 以 <code>$options</code> 形式， <code>data</code> 以 <code>_data_</code> 形式，挂载在实例上</p> <p><img src="https://i.loli.net/2020/10/26/sOAYtQkwcy7pzH9.png" alt="image.png"></p> <h3 id="代理-proxy"><a href="#代理-proxy" class="header-anchor">#</a> 代理 proxy</h3> <p>代理就是使用 <code>vm.xxx</code> 去获取或更改 <code>vm._data.xxx</code> ，同时也将 <code>data</code> 上的所有属性挂载在实例上</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">proxyData</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 此处的前两个参数可以理解为：vm.xxx(key为.后xxx)</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token comment">// 使用代理后可以直接使用vm.xxx来获取或修改vm._data.xxx</span>
            <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span> vm<span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  vm<span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
            <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 官方源码</span>
<span class="token keyword">function</span> <span class="token function">proxy</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> sourceKey<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">proxyGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">proxySetter</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> sharedPropertyDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="观察者-observer"><a href="#观察者-observer" class="header-anchor">#</a> 观察者 observer</h3> <p>对data及其内部的属性进行观察，由于对对象和数组的处理方法不一样，需要分两部分处理：</p> <ul><li>处理对象使用 <code>Object.defineProperty</code> 方法</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 只观察引用类型，即对象或数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> data <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> data <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">var</span> ob
    <span class="token comment">// 已被观察则返回data.__ob__，省去多余操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>__ob__ <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>__ob__ <span class="token keyword">instanceof</span> <span class="token class-name">Observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ob <span class="token operator">=</span> data<span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ob
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">def</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> enumerable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        value<span class="token operator">:</span> val<span class="token punctuation">,</span>
        enumerable<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>enumerable<span class="token punctuation">,</span>
        writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        configurable<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Observer</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将Observer对象挂载到被观察的对象上，标识是否已被观察</span>
    <span class="token function">def</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrMethods
        <span class="token function">observeArr</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">Observer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">walk</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token comment">// 遍历data的所有key和value</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
            value <span class="token operator">=</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>

        <span class="token function">defineReactiveData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>添加响应式数据处理</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">defineReactiveData</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 递归观察</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 响应式数据获取</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'响应式数据获取: '</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> value
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 响应式数据设置</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'响应式数据设置'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token keyword">return</span>
            <span class="token comment">// 观察新值</span>
            <span class="token function">observe</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
            value <span class="token operator">=</span> newValue
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>若是数组，则需要对数组方法进行拦截，重写所有会改变原数组的方法</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 存放所有会改变原数组的方法</span>
<span class="token keyword">var</span> <span class="token constant">ARR_METHODS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'push'</span><span class="token punctuation">,</span>
    <span class="token string">'pop'</span><span class="token punctuation">,</span>
    <span class="token string">'shift'</span><span class="token punctuation">,</span>
    <span class="token string">'unshift'</span><span class="token punctuation">,</span>
    <span class="token string">'splice'</span><span class="token punctuation">,</span>
    <span class="token string">'sort'</span><span class="token punctuation">,</span>
    <span class="token string">'reverse'</span>
<span class="token punctuation">]</span>

<span class="token comment">// 继承Array类</span>
<span class="token keyword">var</span> originArrMethods <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span>
    arrMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>originArrMethods<span class="token punctuation">)</span>

<span class="token comment">// 遍历ARR_METHODS，一个一个重写里面的方法</span>
<span class="token constant">ARR_METHODS</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    arrMethods<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数组新方法'</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">,</span>
            rt <span class="token operator">=</span> originArrMethods<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>

        <span class="token keyword">var</span> newArr

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token operator">:</span>
                newArr <span class="token operator">=</span> args
                <span class="token keyword">break</span>
            <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token operator">:</span>
                newArr <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span>
        <span class="token punctuation">}</span>

        newArr <span class="token operator">&amp;&amp;</span> <span class="token function">observeArr</span><span class="token punctuation">(</span>newArr<span class="token punctuation">)</span>
        <span class="token keyword">return</span> rt
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">observeArr</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">observe</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>重写所有会改变原数组的方法后：</p> <p><img src="https://i.loli.net/2020/10/26/xrNTctaFl8PVBnI.png" alt="image.png"></p> <h2 id="模板编译"><a href="#模板编译" class="header-anchor">#</a> 模板编译</h2> <h3 id="原理流程图-2"><a href="#原理流程图-2" class="header-anchor">#</a> 原理流程图</h3> <p><img src="https://i.loli.net/2020/10/25/VsgfWzO1rAT2m8X.png" alt="image.png"></p> <h3 id="编译入口"><a href="#编译入口" class="header-anchor">#</a> 编译入口</h3> <p>通过<strong>el</strong>或<strong>template</strong>或<strong>render</strong>来获取HTML模板（template）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> inBrowser <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">;</span>

<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
          options <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options

    el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> inBrowser <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span>
    vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> el

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>template <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            template <span class="token operator">=</span> el<span class="token punctuation">.</span>outerHTML
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">compileToRenderFunction</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span>
        options<span class="token punctuation">.</span>render <span class="token operator">=</span> render
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="渲染函数编译入口"><a href="#渲染函数编译入口" class="header-anchor">#</a> 渲染函数编译入口</h3> <p>生成渲染函数，需要先将HTML模板解析为AST树，再由AST树通过拼接字符串的方式去生成渲染函数的函数体字符串，最后通过 <code>new Function()</code> 传入函数题字符串来生成渲染函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">compileToRenderFunction</span><span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parseHtmlToAST</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">,</span>
          code <span class="token operator">=</span> ast <span class="token operator">?</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">'_c(&quot;div&quot;)'</span><span class="token punctuation">,</span>
          render <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
              with(this){ return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> }
		  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> render
<span class="token punctuation">}</span>
</code></pre></div><p>生成渲染函数的过程（第一个为HTML模板字符串）：</p> <p><img src="https://i.loli.net/2020/11/01/YWUldSJ3V9bkwri.png" alt="image.png"></p> <h3 id="构建ast树"><a href="#构建ast树" class="header-anchor">#</a> 构建AST树</h3> <p>通过获取的template来生成AST树（Abstract Syntax Tree 抽象语法树）</p> <ul><li>使用正则去匹配标签名、属性等：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 匹配属性：id=&quot;app&quot; | id='app | id=app</span>
<span class="token keyword">const</span> attribute <span class="token operator">=</span> <span class="token regex">/^\s*([^\s&quot;'&lt;&gt;\/=]+)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|'([^']*)'+|([^\s&quot;'=&lt;&gt;`]+)))?/</span>
<span class="token comment">// 匹配标签名</span>
<span class="token keyword">const</span> ncname <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[a-zA-Z_][\\-\\.0-9_a-zA-Z]*</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> qnameCapture <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">((?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\:)?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
<span class="token comment">// 匹配开始标签：&lt;div</span>
<span class="token keyword">const</span> startTagOpen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token comment">// 匹配结束标签：&gt; | /&gt;</span>
<span class="token keyword">const</span> startTagClose <span class="token operator">=</span> <span class="token regex">/^\s*(\/?)&gt;/</span>
<span class="token comment">// 匹配整个结束标签：&lt;/div&gt;</span>
<span class="token keyword">const</span> endTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;\\/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[^&gt;]*&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>使用解析函数将HTML模板转换为AST树，工作原理：</p> <p>从头开始匹配第一个标签或文本，每匹配到一次就将匹配到的标签或文本解析为一个AST树节点，并将其从HTML模板中删去；</p> <p>若匹配到的是一个开始标签，则将标签名压入栈中；</p> <p>若为结束标签，则对应的解析出的AST树节点将会以相应的父子关系添加进AST树中，然后继续从头匹配下一个标签或文本，直到HTML模板长度为0结束</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseHtmlToAST</span><span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> text<span class="token punctuation">,</span>
        root<span class="token punctuation">,</span>
        currentParent<span class="token punctuation">,</span>
        stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> textEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span>
        <span class="token comment">// 以 &lt; 开头时才去匹配标签</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> startTagMatch <span class="token operator">=</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>startTagMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">start</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span> startTagMatch<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">const</span> endTagMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>endTagMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">advance</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
                <span class="token function">end</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            text <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> textEnd<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">advance</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            <span class="token function">chars</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 通过开始标签（例如：&lt;div）来匹配到每一个标签</span>
    <span class="token keyword">function</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> end<span class="token punctuation">,</span>
            attr

        <span class="token keyword">const</span> start <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagOpen<span class="token punctuation">)</span>

        <span class="token comment">// match()匹配失败时返回一个null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token punctuation">{</span>
                tagName<span class="token operator">:</span> start<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                attrs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
            <span class="token function">advance</span><span class="token punctuation">(</span>start<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>

            <span class="token comment">// 获取标签的所有属性</span>
            <span class="token comment">// 赋值语句会返回所赋给变量的值，以此判断是否匹配到相应内容</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>end <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>attr <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    name<span class="token operator">:</span> attr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    value<span class="token operator">:</span> attr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">||</span> attr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">||</span> attr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token function">advance</span><span class="token punctuation">(</span>attr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">advance</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
                <span class="token keyword">return</span> match
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">advance</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 匹配到开始标签，则将该标签压入栈中</span>
    <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">tagName<span class="token punctuation">,</span> attrs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            root <span class="token operator">=</span> element
        <span class="token punctuation">}</span>

        <span class="token comment">// 将当前节点存为currentParent，以便进入子节点后使用</span>
        currentParent <span class="token operator">=</span> element
        stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 匹配到结束标签时，将该标签弹出栈，设置其父节点为当前父节点，并存入当前父节点的子节点数组中</span>
    <span class="token keyword">function</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token parameter">tagName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> element <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        currentParent <span class="token operator">=</span> stack<span class="token punctuation">[</span>stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentParent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            element<span class="token punctuation">.</span>parent <span class="token operator">=</span> currentParent
            currentParent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理纯文本，直接存入当前父节点的子节点数组中</span>
    <span class="token keyword">function</span> <span class="token function">chars</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            currentParent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                text
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 生成AST树节点</span>
    <span class="token keyword">function</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span><span class="token parameter">tagName<span class="token punctuation">,</span> attrs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            tag<span class="token operator">:</span> tagName<span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            attrs<span class="token punctuation">,</span>
            parent
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> root
<span class="token punctuation">}</span>
</code></pre></div><p>解析过程中，HTML模板字符串的变化（部分）：</p> <p><img src="https://i.loli.net/2020/11/02/grMNlvusAHdWh4C.png" alt="image.png"></p> <p>栈内元素的变化情况：</p> <p><img src="https://i.loli.net/2020/11/01/GzdB1nKCP7TbmVZ.png" alt="image.png"></p> <p>最终解析出的AST树：</p> <p><img src="https://i.loli.net/2020/11/01/3kqDV4CI2WhAiNl.png" alt="image.png"></p> <h3 id="生成渲染函数"><a href="#生成渲染函数" class="header-anchor">#</a> 生成渲染函数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token function">getChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
    <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_c('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">', </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span>
        <span class="token operator">?</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">formatProps</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token operator">:</span>
        <span class="token string">'undefined'</span>
        <span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span>
        <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>

    <span class="token keyword">return</span> code
<span class="token punctuation">}</span>
</code></pre></div><h3 id="虚拟dom"><a href="#虚拟dom" class="header-anchor">#</a> 虚拟DOM</h3> <p>通过AST树解析出虚拟DOM，再用 <code>patch()</code> 函数以打补丁的形式将虚拟DOM转换为真实的DOM</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">renderMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建节点函数</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_c</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理{{ }}中的值，若为对象则转为字符串</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_s</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token keyword">return</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> value
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理纯文本内容</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_v</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">createTextVnode</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
              render <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render<span class="token punctuation">,</span>
              vnode <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>

        <span class="token keyword">return</span> vnode
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="依赖收集"><a href="#依赖收集" class="header-anchor">#</a> 依赖收集</h2></div> <div data-v-5415fd20 data-v-6c3d5eab><div id="valine-vuepress-comment" data-v-5415fd20></div> <span id="<Your/Path/Name>" data-flag-title="Your Article Title" class="leancloud_visitors" data-v-5415fd20><em class="post-meta-item-text" data-v-5415fd20>阅读量 </em> <i class="leancloud-visitors-count" data-v-5415fd20></i></span></div></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c0739d9a.js" defer></script><script src="/assets/js/3.2317019a.js" defer></script><script src="/assets/js/2.d1fb53ea.js" defer></script><script src="/assets/js/26.8ff8d018.js" defer></script><script src="/assets/js/7.441501ce.js" defer></script>
  </body>
</html>
